{% extends "base.html" %}
{% load static %}
{% load thumbnail %}

{% block content %}
<main class="container my-4">
    <div class="row">
        <!-- Колонка категорий -->
        <div class="col-md-3" style="top: 20px; height: fit-content;">
            <div class="card mb-4 category-card">
                <div class="card-header text-white"
                    style="background-color: #010e36ff;">
                    <h5 class="mb-0">Категории</h5>
                </div>
                <div class="list-group list-group-flush" 
                    style="max-height: 200vh; overflow-y: auto; font-size: 1.15rem;">
                    {% for category in categories %}
                        {% if not category.parent %}
                        <div class="list-group-item p-0" >
                            {% if category.children.all %}
                                <a href="#" class="d-block p-2 text-decoration-none" data-bs-toggle="collapse" 
                                data-bs-target="#subcategories-{{ category.id }}" style="color: #011041ca;">
                                    {{ category.name }} <i class="bi bi-chevron-down float-end"></i>
                                </a>
                                <div class="collapse" id="subcategories-{{ category.id }}" style="color: #011041ca;">
                                    <div class="list-group list-group-flush" style="color: #011041ca;">
                                        {% for child in category.children.all %}
                                            <a href="{{ child.get_absolute_url }}" class="list-group-item list-group-item-action ps-4">
                                                {{ child.name }}
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                <a href="{{ category.get_absolute_url }}" class="d-block p-2 text-decoration-none" style="color: #011041ca;">
                                    {{ category.name }}
                                </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Основная колонка -->
        <div class="col-md-9">
            <div class="banner text-center mb-3">  
                <h2 class="mb-3">Добро пожаловать в мир магии и волшебства!</h2>
                <p class="lead mb-5">Сделайте магию Вашим рутинным делом!</p>
            </div>

            <div class="row mb-2">
                <div class="col-12">
                    <form method="get" action="{% url 'shop:products' %}" class="d-flex">
                        <input 
                            type="search" 
                            class="form-control me-2" 
                            placeholder="Поиск..." 
                            name="q"
                            aria-label="Search"
                            value="{{ search_query|default:'' }}"
                        >
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>
                </div>
            </div>

            <h3 class="mb-4 text-center">Товары</h3>

            <div class="row">
                {% for product in products %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        {% if product.image %}
                            <a href="{{ product.get_absolute_url }}">
                                {% thumbnail product.image "500x500" crop="center" as im %}
                                    <img src="{{ im.url }}" class="card-img-top" alt="{{ product.title }}">
                                {% endthumbnail %}
                            </a>
                        {% else %}
                            <a href="{{ product.get_absolute_url }}">
                                <img src="{% static 'images/no-image.jpg' %}" class="card-img-top" alt="Нет изображения">
                            </a>
                        {% endif %}
                        <div class="card-body text-center">
                            <h5 class="card-title">{{ product.title }}</h5>
                            <p class="card-text">{{ product.brand }}</p>
                            <p class="card-text">{{ product.description|truncatechars:50 }}</p>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="h5 price">{{ product.price }} $</span>
                                <a href="#" data-product-id="{{ product.id }}" class="btn btn-sm btn-outline-primary add-to-cart-btn">
                                    В корзину
                                </a>
                            </div>
                            <a href="{{ product.get_absolute_url }}" class="btn btn-sm btn-outline-secondary w-100">Подробнее</a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-info text-center">Совы пока не доставили новый товаров...</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% if products.paginator.num_pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mt-4">
                {% if products.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1" aria-label="First">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ products.previous_page_number }}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% endif %}

                {% for num in products.paginator.page_range %}
                    {% if products.number == num %}
                        <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                    {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if products.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ products.next_page_number }}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ products.paginator.num_pages }}" aria-label="Last">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</main>

<script>
    $(document).on('click', '.add-to-cart-btn', function(e){
        e.preventDefault();
        const productId = $(this).data('product-id');
        const productQty = 1;
        $.ajax({
            type: 'POST',
            url: '{% url "cart:add-to-cart" %}',
            data: {
                product_id: productId,
                product_qty: productQty,
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function(response){
                document.getElementById('lblCartCount').textContent=response.qty;
                // alert('Товар добавлен в корзину!');
            },
            error: function(error){
                console.log(error);
            }
        })
    })
</script>

{% endblock %}