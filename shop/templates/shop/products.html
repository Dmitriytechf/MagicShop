{% extends "base.html" %}
{% load static %}

{% block content %}
<main class="container my-4">
    <div class="row">
        <!-- Колонка категорий -->
        <div class="col-md-3 position-sticky" style="top: 20px; height: fit-content;">
            <div class="card mb-4 category-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Категории</h5>
                </div>
                <div class="list-group list-group-flush" 
                    style="max-height: 200vh; overflow-y: auto; font-size: 1.15rem;">
                    {% for category in categories %}
                        {% if not category.parent %}
                        <div class="list-group-item p-0">
                            {% if category.children.all %}
                                <a href="#" class="d-block p-2 text-decoration-none" data-bs-toggle="collapse" data-bs-target="#subcategories-{{ category.id }}">
                                    {{ category.name }} <i class="bi bi-chevron-down float-end"></i>
                                </a>
                                <div class="collapse" id="subcategories-{{ category.id }}">
                                    <div class="list-group list-group-flush">
                                        {% for child in category.children.all %}
                                            <a href="{{ child.get_absolute_url }}" class="list-group-item list-group-item-action ps-4">
                                                {{ child.name }}
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                <a href="{{ category.get_absolute_url }}" class="d-block p-2 text-decoration-none">
                                    {{ category.name }}
                                </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Основная колонка -->
        <div class="col-md-9">
            <div class="banner text-center mb-3">  
                <h2 class="mb-3">Добро пожаловать в мир магии и волшебства!</h2>
                <p class="lead mb-4">Сделайте магию Вашим рутинным делом!</p>
            </div>

            <h3 class="mb-4 text-center">Товары</h3>

            <div class="row">
                {% for product in products %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.title }}">
                        {% else %}
                        <img src="{% static 'images/no-image.jpg' %}" class="card-img-top" alt="Нет изображения">
                        {% endif %}
                        <div class="card-body text-center">
                            <h5 class="card-title">{{ product.title }}</h5>
                            <p class="card-text">{{ product.brand }}</p>
                            <p class="card-text">{{ product.description|truncatechars:50 }}</p>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="h5 price">{{ product.price }} $</span>
                                <a href="#" data-product-id="{{ product.id }}" class="btn btn-sm btn-outline-primary add-to-cart-btn">
                                    В корзину
                                </a>
                            </div>
                            <a href="{{ product.get_absolute_url }}" class="btn btn-sm btn-outline-secondary w-100">Подробнее</a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-info text-center">Совы пока не доставили новый товаров...</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</main>

<script>
    $(document).on('click', '.add-to-cart-btn', function(e){
        e.preventDefault();
        const productId = $(this).data('product-id');
        const productQty = 1;
        $.ajax({
            type: 'POST',
            url: '{% url "cart:add-to-cart" %}',
            data: {
                product_id: productId,
                product_qty: productQty,
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function(response){
                document.getElementById('lblCartCount').textContent=response.qty;
                // alert('Товар добавлен в корзину!');
            },
            error: function(error){
                console.log(error);
            }
        })
    })
</script>

{% endblock %}